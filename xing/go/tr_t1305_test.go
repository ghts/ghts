package xing

import (
	lb "github.com/ghts/ghts/lib"
	"github.com/ghts/ghts/xing/base"
	"time"

	"testing"
)

func TestT1305_기간별_주가_조회(t *testing.T) {
	t.Parallel()

	종목코드 := F임의_종목().G코드()
	일주월_구분 := ([]xt.T일주월년_구분{xt.P일주월_일, xt.P일주월_주, xt.P일주월_월})[lb.F임의_범위_이내_정수값(0, 2)]
	var 이전_일자 time.Time

	값_모음, 에러 := TrT1305_기간별_주가_조회(종목코드, 일주월_구분, 300)
	lb.F테스트_에러없음(t, 에러)

	for i, 값 := range 값_모음 {
		lb.F테스트_같음(t, 종목코드, 값.M종목코드)
		lb.F테스트_같음(t, len(값.M거래소별_단축코드), 6, 7)

		if len(값.M거래소별_단축코드) == 6 {
			lb.F테스트_같음(t, 종목코드, 값.M거래소별_단축코드)
		} else if len(값.M거래소별_단축코드) == 7 {
			lb.F테스트_같음(t, 값.M거래소별_단축코드[0], "N", "U")
		}

		lb.F테스트_같음(t, 값.M일자.Hour(), 0)
		lb.F테스트_같음(t, 값.M일자.Minute(), 0)
		lb.F테스트_같음(t, 값.M일자.Second(), 0)
		lb.F테스트_같음(t, 값.M일자.Nanosecond(), 0)
		lb.F테스트_참임(t, 값.M일자.After(이전_일자) || 값.M일자.Equal(이전_일자))
		이전_일자 = 값.M일자

		if i > 0 {
			차이 := lb.F절대값(값.M일자.Sub(값_모음[i-1].M일자).Hours() / 24)

			switch 일주월_구분 {
			case xt.P일주월_일:
				lb.F테스트_참임(t, 차이 >= 1 && 차이 < 13, 종목코드, 값_모음[i-1].M일자, 값.M일자, 차이)
			case xt.P일주월_주:
				lb.F테스트_참임(t, 차이 >= 3 && 차이 < 20, 종목코드, 값_모음[i-1].M일자, 값.M일자, 차이)
			case xt.P일주월_월:
				lb.F테스트_참임(t, 차이 >= 20 && 차이 < 45, 종목코드, 값_모음[i-1].M일자, 값.M일자, 차이)
			default:
				panic(lb.New에러("예상하지 못한 일주월 구분값 : '%v'", 일주월_구분))
			}
		}

		if 값.M고가 > 0 {
			lb.F테스트_참임(t, 값.M고가 >= 값.M시가, 값.M종목코드, 값.M고가, 값.M시가)
			lb.F테스트_참임(t, 값.M고가 >= 값.M종가, 값.M종목코드, 값.M고가, 값.M종가)
			lb.F테스트_참임(t, 값.M고가 >= 값.M저가, 값.M종목코드, 값.M고가, 값.M저가)
			lb.F테스트_참임(t, 값.M저가 <= 값.M시가, 값.M종목코드, 값.M저가, 값.M시가)
			lb.F테스트_참임(t, 값.M저가 <= 값.M종가, 값.M종목코드, 값.M저가, 값.M종가)
		}

		// 저가 한계값에 대한 추정에 자신이 없어서 일단 건너뜀.
		//최소_호가단위, 에러 := lb.F최소_호가단위by종목코드(값.M종목코드)
		//lb.F테스트_에러없음(t, 에러)
		//저가_한계 :=  int64(float64(값.M고가 - 최소_호가단위) * 0.7) - 최소_호가단위
		//lb.F테스트_참임(t, 값.M저가 >= 저가_한계, 값.M저가, 저가_한계)

		switch 값.M전일대비구분 {
		case xt.P구분_상한, xt.P구분_상승:
			lb.F테스트_참임(t, 값.M전일대비등락폭 > 0)
			lb.F테스트_참임(t, 값.M전일대비등락율 >= 0, 값.M전일대비구분, 값.M전일대비등락율)
		case xt.P구분_보합:
			lb.F테스트_같음(t, 값.M전일대비등락폭, 0)
			lb.F테스트_같음(t, 값.M전일대비등락율, 0)
		case xt.P구분_하한, xt.P구분_하락:
			lb.F테스트_참임(t, 값.M전일대비등락폭 < 0,
				"종목코드 : '%v', 구분 : '%v', 등락폭 : '%v'",
				종목코드, 값.M전일대비구분, 값.M전일대비등락폭)

			lb.F테스트_참임(t, 값.M전일대비등락율 <= 0,
				"종목코드 : '%v', 구분 : '%v', 등락율 : '%v'",
				종목코드, 값.M전일대비구분, 값.M전일대비등락율)
		default:
			if lb.F확인2(lb.F2정수64(값.M전일대비등락폭)) == 0 &&
				lb.F확인2(lb.F2실수(값.M전일대비등락율)) == 0.0 {
				값.M전일대비구분 = xt.P구분_보합
			} else {
				lb.F문자열_출력("일주월 구분 : '%v', 종목코드 : '%v', 일자 : '%v', 전일대비구분 : '%v'",
					일주월_구분, 값.M종목코드, 값.M일자.Format(lb.P일자_형식), 값.M전일대비구분)
				t.FailNow()
			}
		}

		switch 값.M시가대비구분 {
		case xt.P구분_상한, xt.P구분_상승:
			lb.F테스트_참임(t, 값.M시가대비등락폭 > 0)
			lb.F테스트_참임(t, 값.M시가대비등락율 >= 0)
		case xt.P구분_보합:
			lb.F테스트_참임(t, 값.M시가대비등락폭 == 0)
			lb.F테스트_참임(t, 값.M시가대비등락율 == 0)
		case xt.P구분_하한, xt.P구분_하락:
			lb.F테스트_참임(t, 값.M시가대비등락폭 < 0)
			lb.F테스트_참임(t, 값.M시가대비등락율 <= 0)
		default:
			lb.F문자열_출력("일주월 구분 : '%v', 종목코드 : '%v', 일자 : '%v', 시가대비구분 : '%v'",
				일주월_구분, 값.M종목코드, 값.M일자, 값.M시가대비구분)
			t.FailNow()
		}

		switch 값.M고가대비구분 {
		case xt.P구분_상한, xt.P구분_상승:
			lb.F테스트_참임(t, 값.M고가대비등락폭 > 0)
			lb.F테스트_참임(t, 값.M고가대비등락율 > 0)
		case xt.P구분_보합:
			lb.F테스트_참임(t, 값.M고가대비등락폭 == 0)
			lb.F테스트_참임(t, 값.M고가대비등락율 == 0)
		case xt.P구분_하한, xt.P구분_하락:
			lb.F테스트_참임(t, 값.M고가대비등락폭 < 0)
			lb.F테스트_참임(t, 값.M고가대비등락율 < 0)
		default:
			lb.F문자열_출력("일주월 구분 : '%v', 종목코드 : '%v', 일자 : '%v', 고가대비구분 : '%v'",
				일주월_구분, 값.M종목코드, 값.M일자, 값.M고가대비구분)
			t.FailNow()
		}

		switch 값.M저가대비구분 {
		case xt.P구분_상한, xt.P구분_상승:
			lb.F테스트_참임(t, 값.M저가대비등락폭 > 0)
			lb.F테스트_참임(t, 값.M저가대비등락율 > 0)
		case xt.P구분_보합:
			lb.F테스트_참임(t, 값.M저가대비등락폭 == 0)
			lb.F테스트_참임(t, 값.M저가대비등락율 == 0)
		case xt.P구분_하한, xt.P구분_하락:
			lb.F테스트_참임(t, 값.M저가대비등락폭 < 0)
			lb.F테스트_참임(t, 값.M저가대비등락율 < 0, 값.M저가대비등락율)
		default:
			lb.F문자열_출력("일주월 구분 : '%v', 종목코드 : '%v', 일자 : '%v', 저가대비구분 : '%v'",
				일주월_구분, 값.M종목코드, 값.M일자, 값.M저가대비구분)
			t.FailNow()
		}

		lb.F테스트_참임(t, 값.M거래량 >= 0)
		lb.F테스트_참임(t, 값.M거래대금_백만 >= 0)
		//lb.F테스트_참임(t, 값.M거래_증가율)
		lb.F테스트_참임(t, 값.M체결강도 >= 0)
		lb.F테스트_참임(t, 값.M소진율 >= 0)
		lb.F테스트_참임(t, 값.M회전율 >= 0)
		//lb.F테스트_참임(t, 값.M외국인_순매수)
		//lb.F테스트_참임(t, 값.M기관_순매수)
		//lb.F테스트_참임(t, 값.M개인_순매수)
		lb.F테스트_참임(t, 값.M시가총액_백만 > 0)
	}
}
